name: Minify and Build

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 1
      - name: Install minify CLI
        run: |
          sudo apt-get update -y
          sudo apt-get install -y minify
      - name: Copy repository into dist directory
        run: |
          mkdir -p dist
          rsync -a --exclude='.git' ./ dist/
      - name: Minify assets (best effort)
        run: |
          set -euo pipefail

          minify_one () {
            local f="$1"
            local tmp="${f}.tmp"

            if [[ "$f" == *.min.js || "$f" == *.min.css ]]; then
              echo "::notice file=$f::Skipping already-minified file"
              return 0
            fi

            local size
            size=$(stat -c%s "$f" 2>/dev/null || stat -f%z "$f")
            if [[ "$size" -gt 300000 ]]; then
              echo "::notice file=$f::Skipping large file (${size} bytes)"
              return 0
            fi

            if ! minify "$f" > "$tmp" 2>minify_err.log; then
              echo "::warning file=$f::Minify failed, leaving original. $(head -c 180 minify_err.log | tr '\n' ' ')"
              rm -f "$tmp" minify_err.log
              return 0
            fi

            mv "$tmp" "$f"
            rm -f minify_err.log
          }

          while IFS= read -r -d '' f; do
            minify_one "$f"
          done < <(find dist -type f \( -name '*.html' -o -name '*.css' -o -name '*.js' \) -print0)

      - name: Upload minified site artifact
        uses: actions/upload-artifact@v4
        with:
          name: site-dist
          path: dist
